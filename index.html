<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Map</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

    <!-- Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>


    <style>
        #map { height: 800px; }
        .popup-image {
            max-width: 200px;
            height: auto;
        }

    </style>
    
</head>
<body>
    <h1>Campus Map</h1>
    <div class="row">
        <div class="col-4">
            <h2 >CR List</h2>
            <div id="crCardList" style="margin-left: 1rem;"></div>
        </div>
        <div class="col-8">
            <div id="map"></div>
        </div>
    </div>
     
</body>
<script>
let map; // global map
const markerMap = {}; // global marker map

// Initialize Leaflet map
function initMap(mapDataUrl) {
    map = L.map('map').setView([8.3603, 124.8684], 17);

    // Base layers
    const openStreetMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const satellite = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', 
        { attribution:'Tiles (c) Esri - Source: Esri, Maxar, Earthstar Geographics, GIS User Community' }
    );

    const markerGroups = {};

    // Custom icon
    const customIcon = L.icon({
        iconUrl:'assets/toilet-bowl.png',
        iconSize: [38,38],
        iconAnchor: [19,38],
        popupAnchor: [0,-38]    
    });

    fetch(mapDataUrl)
        .then(response => response.json())
        .then(data => {
            data.forEach(pin => {
                const type = pin.locationType || "Other";

                if(!markerGroups[type]){
                    markerGroups[type] = L.layerGroup();
                }

                const marker = L.marker([pin.lat, pin.lng], { icon: customIcon })
                    .bindPopup(`
                        <img src="${pin.img}" class="popup-image">
                        <b>${pin.title}</b><br>
                        ${pin.description}<br>
                        <i>${pin.comment}</i><br>
                        <h1>${pin.rating}</h1>
                    `)
                    .addTo(map);

                markerGroups[type].addLayer(marker);

                // Store marker for flyTo
                markerMap[pin.id] = marker;
            });

            // Add all groups to map
            Object.values(markerGroups).forEach(group => group.addTo(map));

            // Layer control
            const baseMaps = { "OpenStreetMap": openStreetMap, "Satellite": satellite };
            const overlayMaps = {};
            Object.keys(markerGroups).forEach(type => overlayMaps[type] = markerGroups[type]);

            L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);
        })
        .catch(err => console.error("Error loading JSON:", err));
}

// Render CR cards
function renderCards(crDataUrl, containerId) {
    fetch(crDataUrl)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById(containerId);
            container.innerHTML = "";

            data.forEach(cr => {
                const cardHTML = `
                    <div class="card mb-2" data-crid="${cr.id}">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-4">
                                    <img src="${cr.img}" class="card-img-top" alt="${cr.title}">
                                </div>
                                <div class="col-8">
                                    <h5 class="card-title">${cr.title}</h5>
                                    <p class="card-text">${cr.rating}</p>
                                    <p class="card-text">${cr.description}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });

            // Add click event to fly to marker
            container.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', () => {
                    const crID = card.getAttribute('data-crid');
                    const marker = markerMap[crID];
                    if(marker){
                        map.flyTo(marker.getLatLng(), 19, { duration: .5 });
                        marker.openPopup();
                    }
                });
            });
        })
        .catch(error => console.error("Error loading JSON:", error));
}

// Initialize on DOM ready
document.addEventListener("DOMContentLoaded", () => {
    initMap('cr-list.json');
    renderCards('cr-list.json','crCardList');
});


</script>
</html>